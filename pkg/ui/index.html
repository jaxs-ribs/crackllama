<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    <title>Crackllama</title>
</head>
<body>
    <div>
        <textarea id="promptInput" placeholder="Enter your prompt" onkeypress="handleKeyPress(event)" rows="1"></textarea>
    </div>
    <div id="answerDisplay"></div>

    <style>
        body {
            background-color: #1e1e1e; /* Dark grey background */
            color: rgb(239, 239, 239); /* White text color */
            font-family: 'Courier New', monospace; /* Change to serif monospace font */
            margin: 0;
            padding: 20px;
        }
        textarea {
            margin: 0; /* Reset margin */
            width: calc(100% - 20px); /* Adjust width considering padding */
            padding: 10px;
            border: none;
            border-radius: 20px;
            background-color: #272727;
            color: rgb(221, 221, 221);
            position: fixed;
            bottom: 10px;
            left: 10px;
            right: 10px;
            resize: none;
            overflow: hidden;
            box-sizing: border-box;
        }
        #answerDisplay {
            margin-top: 20px;
            padding: 10px;
            border-radius: 5px;
        }
        .speedRead {
            font-size: 64px; /* Larger font size */
        }
        .fullText {
            font-size: 16px; /* Normal font size */
            font-weight: normal; /* Normal font weight */
            display: block; /* Block display to mimic a text box */
            white-space: pre-wrap; /* Ensures that spaces and line breaks are respected */
            background-color: #232323; /* Lighter grey for the text box */
            padding: 10px;
            border-radius: 5px;
        }
        .hidden {
            display: none;
        }
        .centered {
            position: fixed;
            top: 40%;
            left: 35%;
            transform: translate(0%, -50%); /* Adjust transform to maintain vertical centering */
            font-size: 60px; /* Larger font size for speed reading */
            text-align: left; /* Change text alignment to left */
            width: calc(100% - 20px); /* Adjust width to account for padding */
        }
    </style>
    <script>
        window.speedReadingActive = false;
        var speedReadTimeout; // This will hold the timeout ID
        var originalText; // This will hold the original text passed to speedRead

        // Persistent event listener for keydown
        document.addEventListener('keydown', function skipSpeedRead(event) {
            if ((event.key === "Escape" || event.key === " ") && window.speedReadingActive) {
                finishSpeedRead();
            }
        });

        function speedRead(text) {
            originalText = text; // Store the original text
            window.speedReadingActive = true; // Activate speed reading
            const words = text.split(/[\s\n]+/);
            const averageWordLength = 5;
            const wpm = 600;
            let index = 0;
            const display = document.getElementById('answerDisplay');
            display.innerHTML = '';
            display.classList.add('centered');
        
            function displayNextWord() {
                if (index < words.length) {
                    const word = words[index];
                    const wordLength = word.length;
                    let orpIndex; // Index of the ORP character
                    let spaces = ""; // Variable to hold spaces
                    if (wordLength <= 4) {
                        orpIndex = 1;
                        spaces = "&nbsp;&nbsp;&nbsp;"; // Three non-breaking spaces
                    } else if (wordLength <= 9) {
                        orpIndex = 2;
                        spaces = "&nbsp;&nbsp;"; // Two non-breaking spaces
                    } else if (wordLength <= 13) {
                        orpIndex = 3;
                        spaces = "&nbsp;"; // One non-breaking space
                    } else {
                        orpIndex = 4;
                        spaces = ""; // No space
                    }
        
                    // Split the word to insert the highlight span
                    const part1 = spaces + word.substring(0, orpIndex);
                    const part2 = word.substring(orpIndex, orpIndex + 1);
                    const part3 = word.substring(orpIndex + 1);
        
                    const msPerWord = (wordLength / averageWordLength) * (60000 / wpm);
                    display.innerHTML = `<span class="speedRead">${part1}<span style="color: orange;">${part2}</span>${part3}</span>`;
                    index++;
                    speedReadTimeout = setTimeout(displayNextWord, msPerWord);
                } else {
                    finishSpeedRead();
                }
            }
        
            displayNextWord();
        }

        function finishSpeedRead() {
            clearTimeout(speedReadTimeout); // Clear the timeout to stop the speed reading
            const display = document.getElementById('answerDisplay');
            display.innerHTML = `<span class="fullText">${originalText}</span>`; // Display the entire original text
            display.classList.remove('centered');
            document.getElementById('promptInput').classList.remove('hidden');
            document.getElementById('promptInput').focus(); // Focus the cursor on the input box
            window.speedReadingActive = false; // Deactivate speed reading
        }

        function submitPrompt() {
            var promptText = document.getElementById('promptInput').value;
            document.getElementById('promptInput').classList.add('hidden'); // Hide the input box
            fetch('http://localhost:8080/crackllama:crackllama:template.os/prompt', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ prompt: promptText })
            })
            .then(response => response.text())
            .then(data => {
                speedRead(data);
                document.getElementById('promptInput').value = ''; 
                document.getElementById('promptInput').focus(); 
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('answerDisplay').innerText = 'Error fetching response';
                document.getElementById('promptInput').classList.remove('hidden'); // Show the input box on error
            });
        }

        function handleKeyPress(event) {
            if (event.key === "Enter" && !event.shiftKey) {
                event.preventDefault(); // Prevent form submission on Enter
                submitPrompt();
            } else if (event.key === "Enter" && event.shiftKey) {
                // Allow Shift+Enter to insert a new line
                let textarea = document.getElementById('promptInput');
                let cursorPos = textarea.selectionStart;
                let textBefore = textarea.value.substring(0, cursorPos);
                let textAfter  = textarea.value.substring(cursorPos, textarea.value.length);
                textarea.value = textBefore + "\n" + textAfter;
                // Move the cursor to the right position after inserting the newline
                textarea.selectionStart = cursorPos + 1;
                textarea.selectionEnd = cursorPos + 1;
            }
        }

        function autoExpand(field) {
            // Reset field height
            field.style.height = 'inherit';

            // Get the computed styles for the element
            var computed = window.getComputedStyle(field);

            // Calculate the height
            var height = parseInt(computed.getPropertyValue('border-top-width'), 10)
                        + parseInt(computed.getPropertyValue('padding-top'), 10)
                        + field.scrollHeight
                        + parseInt(computed.getPropertyValue('padding-bottom'), 10)
                        + parseInt(computed.getPropertyValue('border-bottom-width'), 10);

            field.style.height = height + 'px';
        }

        document.getElementById('promptInput').addEventListener('input', function() {
            autoExpand(this);
        });

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('promptInput').focus();
        });
    </script>

    
</body>
</html>